"""Patent Vulnerability Assessment - Correlate petition red flags with PTAB challenges"""

from . import mcp


@mcp.prompt(
    name="patent_vulnerability_assessment_ptab",
    description="Correlate petition red flags with PTAB challenge outcomes. At least ONE required (company_name or patent_numbers). vulnerability_threshold: low/medium/high for risk sensitivity. predictive_analysis: true/false for vulnerability modeling. Requires PTAB MCP."
)
async def patent_vulnerability_assessment_ptab_prompt(
    company_name: str = "",
    patent_numbers: str = "",
    vulnerability_threshold: str = "medium",
    predictive_analysis: str = "true"
) -> str:
    """
    Patent vulnerability assessment correlating petition red flags with PTAB challenge outcomes.
    
    Analysis criteria (at least ONE required):
    - company_name: Company/patent owner for portfolio analysis
    - patent_numbers: Specific patents to analyze (comma-separated)
    
    Assessment options:
    - vulnerability_threshold: Risk sensitivity (low, medium, high) [DEFAULT: medium]
    - predictive_analysis: Include predictive vulnerability modeling (true/false) [DEFAULT: true]
    
    Returns comprehensive vulnerability assessment with petition-PTAB correlation analysis and risk prediction.
    """
    return f"""Patent Vulnerability Assessment - Petition Red Flag to PTAB Correlation

Company Name: {company_name}
Patent Numbers: {patent_numbers}
Vulnerability Threshold: {vulnerability_threshold}
Predictive Analysis: {predictive_analysis}

WARNING: DEPENDENCIES: This workflow requires PTAB MCP for post-grant challenge correlation analysis.

 ATTORNEY WORKFLOW: Advanced vulnerability assessment correlating petition red flags with PTAB challenge outcomes to predict post-grant risk and develop defensive strategies.

## COMPLETE IMPLEMENTATION WITH ERROR HANDLING

```python
# PHASE 1: Patent Discovery and Identification
print(f"## PATENT VULNERABILITY ASSESSMENT")
print(f"**Company Name:** {company_name or 'Not provided'}")
print(f"**Patent Numbers:** {patent_numbers or 'Not provided'}")
print(f"**Vulnerability Threshold:** {vulnerability_threshold}")
print(f"**Predictive Analysis:** {predictive_analysis}\\n")

patents_to_analyze = []

if "{patent_numbers}":
    # Parse comma-separated patent numbers
    patents_to_analyze = [p.strip() for p in "{patent_numbers}".split(',')]
    print(f"**Analyzing {{len(patents_to_analyze)}} specific patents**\\n")
elif "{company_name}":
    # Get company portfolio and extract patent numbers
    try:
        pfw_results = pfw_search_applications_minimal(
            applicant_name="{company_name}",
            fields=['patentNumber', 'applicationNumberText', 'inventionTitle'],
            limit=50
        )
        patents_to_analyze = [p.get('patentNumber') for p in pfw_results.get('patents', []) if p.get('patentNumber')]
        print(f"**Found {{len(patents_to_analyze)}} granted patents for {company_name}**\\n")
    except Exception as e:
        print(f"‚ö†Ô∏è Could not retrieve portfolio from PFW: {{e}}\\n")

# PHASE 2: Petition Red Flag Analysis
print("**PHASE 2: Analyzing Petition Red Flags...**\\n")

vulnerability_assessment = {{
    'patents_analyzed': 0,
    'patents_with_petitions': 0,
    'total_red_flags': 0,
    'red_flag_patents': [],
    'petition_patterns': {{
        'revival': 0,
        'examiner_dispute': 0,
        'denied_petitions': 0,
        'multiple_petitions': 0
    }}
}}

# Analyze petition history for each patent
for patent_num in patents_to_analyze[:30]:  # Limit to 30 patents
    if not patent_num:
        continue

    vulnerability_assessment['patents_analyzed'] += 1

    # Get application number for petition search
    try:
        pfw_result = pfw_search_applications_minimal(
            patent_number=patent_num,
            fields=['applicationNumberText'],
            limit=1
        )
        app_num = pfw_result['patents'][0].get('applicationNumberText') if pfw_result.get('patents') else None

        if not app_num:
            continue

        # Search for petitions
        petitions = fpd_search_petitions_by_application(
            application_number=app_num,
            include_documents=False
        )

        petition_count = len(petitions.get('results', []))
        if petition_count > 0:
            vulnerability_assessment['patents_with_petitions'] += 1

            red_flags = []

            # Analyze each petition for red flags
            for petition in petitions.get('results', []):
                petition_id = petition.get('petitionDecisionRecordIdentifier')
                decision = petition.get('decisionTypeCodeDescriptionText', '')

                try:
                    details = fpd_get_petition_details(petition_id=petition_id, include_documents=False)
                    rules = details.get('ruleBag', [])

                    # Identify red flag patterns
                    if any('1.137' in rule for rule in rules):
                        red_flags.append('REVIVAL_PETITION')
                        vulnerability_assessment['petition_patterns']['revival'] += 1
                        if decision == 'DENIED':
                            red_flags.append('DENIED_REVIVAL')
                            vulnerability_assessment['petition_patterns']['denied_petitions'] += 1

                    if any('1.181' in rule for rule in rules):
                        red_flags.append('EXAMINER_DISPUTE')
                        vulnerability_assessment['petition_patterns']['examiner_dispute'] += 1

                except:
                    pass

            if petition_count > 1:
                red_flags.append('MULTIPLE_PETITIONS')
                vulnerability_assessment['petition_patterns']['multiple_petitions'] += 1

            if red_flags:
                vulnerability_assessment['total_red_flags'] += len(red_flags)
                vulnerability_assessment['red_flag_patents'].append({{
                    'patent_num': patent_num,
                    'app_num': app_num,
                    'petition_count': petition_count,
                    'red_flags': red_flags,
                    'vulnerability_score': len(red_flags) * 10  # Simple scoring
                }})

    except Exception as e:
        print(f"‚ö†Ô∏è Could not analyze patent {{patent_num}}: {{e}}")
        continue

print(f"‚úÖ **Petition Red Flag Analysis Complete**")
print(f"- Patents Analyzed: {{vulnerability_assessment['patents_analyzed']}}")
print(f"- Patents with Petitions: {{vulnerability_assessment['patents_with_petitions']}}")
print(f"- Total Red Flags: {{vulnerability_assessment['total_red_flags']}}\\n")

# PHASE 3: PTAB Challenge Correlation
print("**PHASE 3: Correlating with PTAB Challenges...**\\n")

ptab_correlation = {{
    'challenged_patents': 0,
    'instituted_proceedings': 0,
    'red_flag_challenged': 0,
    'correlation_patterns': []
}}

for patent_data in vulnerability_assessment['red_flag_patents'][:20]:
    patent_num = patent_data['patent_num']

    try:
        ptab_proceedings = ptab_search_proceedings_minimal(
            patent_number=patent_num
        )

        proceeding_count = len(ptab_proceedings.get('results', []))
        if proceeding_count > 0:
            ptab_correlation['challenged_patents'] += 1
            ptab_correlation['red_flag_challenged'] += 1

            # Check for institution
            for proceeding in ptab_proceedings.get('results', []):
                status = proceeding.get('proceedingStatus', '').lower()
                if 'instituted' in status:
                    ptab_correlation['instituted_proceedings'] += 1

            # Record correlation pattern
            ptab_correlation['correlation_patterns'].append({{
                'patent_num': patent_num,
                'red_flags': patent_data['red_flags'],
                'ptab_challenges': proceeding_count,
                'vulnerability_confirmed': proceeding_count > 0
            }})

    except Exception as e:
        print(f"**Note:** PTAB MCP unavailable for {{patent_num}}: {{e}}")
        continue

print(f"‚úÖ **PTAB Correlation Analysis Complete**")
print(f"- Patents with PTAB Challenges: {{ptab_correlation['challenged_patents']}}")
print(f"- Instituted Proceedings: {{ptab_correlation['instituted_proceedings']}}")
print(f"- Red Flag Patents Challenged: {{ptab_correlation['red_flag_challenged']}}\\n")

# PHASE 4: Vulnerability Scoring and Prediction
if "{predictive_analysis}" == "true":
    print("**PHASE 4: Predictive Vulnerability Modeling...**\\n")

    # Calculate correlation strength
    correlation_rate = (ptab_correlation['red_flag_challenged'] / len(vulnerability_assessment['red_flag_patents']) * 100) if vulnerability_assessment['red_flag_patents'] else 0

    print(f"**Petition Red Flag ‚Üí PTAB Challenge Correlation:** {{correlation_rate:.1f}}%\\n")

# PHASE 5: PRESENTATION - Vulnerability Report
print("\\n## VULNERABILITY ASSESSMENT SUMMARY\\n")

# Overview
print("### PORTFOLIO OVERVIEW\\n")
print(f"- **Patents Analyzed:** {{vulnerability_assessment['patents_analyzed']}}")
print(f"- **Patents with Petition Red Flags:** {{len(vulnerability_assessment['red_flag_patents'])}}")
print(f"- **Patents with PTAB Challenges:** {{ptab_correlation['challenged_patents']}}")
print(f"- **Correlation Rate:** {{correlation_rate:.1f}}%\\n")

# High Vulnerability Patents
if vulnerability_assessment['red_flag_patents']:
    print("### üö® HIGH VULNERABILITY PATENTS\\n")
    print("| Patent Number | Red Flags | Petition Count | Vulnerability Score |")
    print("|---------------|-----------|----------------|---------------------|")

    # Sort by vulnerability score
    sorted_patents = sorted(vulnerability_assessment['red_flag_patents'],
                          key=lambda x: x['vulnerability_score'], reverse=True)

    for patent in sorted_patents[:15]:
        flags_str = ', '.join(patent['red_flags'])
        print(f"| {{patent['patent_num']}} | {{flags_str}} | {{patent['petition_count']}} | {{patent['vulnerability_score']}} |")

# PTAB Correlation Patterns
if ptab_correlation['correlation_patterns']:
    print("\\n### PETITION-PTAB CORRELATION PATTERNS\\n")
    print("| Patent Number | Petition Red Flags | PTAB Challenges | Status |")
    print("|---------------|--------------------|--------------------|--------|")

    for pattern in ptab_correlation['correlation_patterns'][:10]:
        flags = ', '.join(pattern['red_flags'][:2])  # Show first 2 flags
        status = "üö® CONFIRMED" if pattern['vulnerability_confirmed'] else "‚úÖ No Challenge"
        print(f"| {{pattern['patent_num']}} | {{flags}} | {{pattern['ptab_challenges']}} | {{status}} |")

# RECOMMENDED ACTIONS
print("\\n### RECOMMENDED ACTIONS\\n")

if correlation_rate > 50:
    print("**HIGH CORRELATION DETECTED:**")
    print("1. üö® Petition red flags strongly correlate with PTAB vulnerability")
    print("2. üö® Prioritize defensive strategies for red-flag patents")
    print("3. üö® Consider preemptive claim amendments or reissues")
    print("4. üö® Develop settlement strategies for high-risk patents\\n")
elif correlation_rate > 25:
    print("**MODERATE CORRELATION:**")
    print("1. ‚ö†Ô∏è Monitor red-flag patents for PTAB activity")
    print("2. ‚ö†Ô∏è Prepare defensive claim charts and validity analyses")
    print("3. ‚ö†Ô∏è Review prosecution history for strengthening opportunities\\n")
else:
    print("**LOW CORRELATION:**")
    print("1. ‚úÖ Petition history not strongly predictive of PTAB challenges")
    print("2. ‚úÖ Continue standard monitoring practices")
    print("3. ‚úÖ Focus on other vulnerability indicators\\n")
```

## CRITICAL SAFETY RAILS

**‚ö†Ô∏è IMPORTANT:**
- Limit patent analysis to 30 patents maximum to prevent context explosion
- Petition red flag analysis requires application number lookup via PFW
- PTAB correlation analysis limited to 20 patents with red flags
- Requires PTAB MCP for challenge correlation - will gracefully degrade if unavailable
- Vulnerability scoring is predictive, not determinative - requires legal judgment
- Use vulnerability_threshold to filter analysis scope

## CROSS-MCP INTEGRATION

**With PFW MCP:**
```python
# Get application numbers for petition lookup
for patent_num in patents_to_analyze:
    pfw_result = pfw_search_applications_minimal(
        patent_number=patent_num,
        fields=['applicationNumberText'],
        limit=1
    )
```

**With PTAB MCP:**
```python
# Check PTAB challenge status
try:
    ptab_proceedings = ptab_search_proceedings_minimal(patent_number=patent_num)
    # Correlate with petition red flags
except:
    pass  # Graceful degradation if PTAB MCP unavailable
```

** TRIPLE-MCP INTELLIGENCE**: Combining FPD petition history, PFW prosecution data, and PTAB challenge outcomes reveals vulnerability patterns impossible to detect from single data sources."""


